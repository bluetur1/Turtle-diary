%% 
%第一题  
%实际曲线   
t = [0 10 20 40 60 80 100 140 180 250 300 400 500 600]; % 时间向量
y = [0 0 0.2 0.8 2.0 3.6 5.4 8.8 11.8 14.4 16.6 18.4 19.2 19.6]; % 系统阶跃响应向量
figure;  
plot(t, y); % 原始数据点  
hold on;  
%plot(t_fit, y_fit, 'r-'); %  
xlabel('时间');  
ylabel('液位响应');  
grid on;  
hold on;
%% 

%第二题
%用作图法 
% 用中心差分法 一阶导数
% 假设x和y包含了曲线的坐标
x = [0 10 20 40 60 80 100 140 180 250 300 400 500 600]; % 
y = [0 0 0.2 0.8 2.0 3.6 5.4 8.8 11.8 14.4 16.6 18.4 19.2 19.6]; 

% 计算变化速度（近似导数）
dy = diff(y)./diff(x);
dx = (x(1:end-1) + x(2:end)) / 2; % 计算差分的中点，用于绘图

% 找到最大变化速度的点
[max_dy, idx] = max(abs(dy)); % 找到绝对值最大的变化速度

% 计算切线
% 切线斜率为max_dy，经过点(dx(idx), y(idx+1))
% 切线方程为：y = m(x - x1) + y1
% 其中，m为切线斜率，(x1, y1)是切点
m = dy(idx);
x1 = dx(idx);
y1 = y(idx+1);
% 定义切线的x范围（可根据需要调整）
x_tangent = x1 + linspace(-1, 1, 100);
% 切线的y坐标
y_tangent = m * (x_tangent - x1) + y1;

% 绘制原始曲线
plot(x, y, 'b-', 'LineWidth', 1.5);
hold on;
% 绘制变化速度最大点
plot(x1, y1, 'ro', 'MarkerSize', 10, 'LineWidth', 2);
% 绘制切线
plot(x_tangent, y_tangent, 'r--', 'LineWidth', 1.5);
hold off;
legend('原始曲线', '最大变化速度点', '切线');
xlabel('X');
ylabel('Y');
title('曲线及其最大变化速度点的切线');
grid on;

%----------------------先求出拐点，然后进行各种边界线的划分
%实际曲线
t = [0 10 20 40 60 80 100 140 180 250 300 400 500 600]; % 时间向量
y = [0 0 0.2 0.8 2.0 3.6 5.4 8.8 11.8 14.4 16.6 18.4 19.2 19.6]; % 系统阶跃响应向量
xlabel('时间');  
ylabel('液位响应');  
grid on;  
hold on;
plot(t, y,'o-')
%拐点 （100，5.4）， 与（80 3.6） 两点连线为切线
%斜率slope
slope=(5.4-3.6)/(100-80)  %0.09
x2 = [40 60 80 100 120 140 300] 
y2=slope*(x2-80)+3.6
y2 = [slope*(40-80)+3.6 slope*(60-80)+3.6 3.6 5.4 slope*(120-80)+3.6 slope*(140-80)+3.6 slope*(300-80)+3.6]
plot(x2, y2); % 
hold on
z = 19.6 * ones(size(t)); % 创建一个与x相同大小，但所有值都是19.6的z数组
plot(t,z)
hold on
intersection_x=[(19.6-3.6)/0.09+80]  %;x=(y-3.6)/slope +80
intersection_y=[19.6]
plot(intersection_x,intersection_y,'ro')
%因此可以求得K=输出稳态幅值/输入幅值  K=19.6/输入幅值  
%由图也可以求出延迟时间τ=40s,T=257.778-40
T=257.778-40  %T=217.778
%即通过作图法可以确定一阶惯性加滞后环节的参数 
% τ=40s T=217.778s  K=稳态值（19.6）/输入幅值 = ，（题目貌似未给出阶跃输入幅值Δx 这里仅能给出表达式）

%假设输入幅值为0.2
% 定义传递函数的分子和分母多项式系数  
num = [19.6/0.2];   %98
den = [217.778 1];  
g=tf(num,den,'ioDelay',40)
step(g*0.2)
hold on
xlim([0,600])


%% 
%第三题  与实际值对比检验
%  
%实际曲线   
t = [0 10 20 40 60 80 100 140 180 250 300 400 500 600]; % 时间向量
y = [0 0 0.2 0.8 2.0 3.6 5.4 8.8 11.8 14.4 16.6 18.4 19.2 19.6]; % 系统阶跃响应向量
figure;  
plot(t, y,'r-'); % 原始数据点  
hold on;  
%plot(t_fit, y_fit, 'r-'); %  
xlabel('时间');  
ylabel('液位响应');  
grid on;  
hold on;

num = [19.6/0.2];   %98
den = [217.778 1];  
g=tf(num,den,'ioDelay',40)
step(g*0.2)
hold on
xlim([0,600])
legend('实际曲线','作图法');  
%分析： 作图法求出的模型  与实际曲线相差确实比较大，误差比较大，但处于可以接受的范围
%作图法的结果也可以当作其阶跃响应


